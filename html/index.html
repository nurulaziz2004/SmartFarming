<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>ðŸŒ± Smart Farming Dashboard</title>
<style>
body { font-family: Arial; margin:18px; }
.row { display:flex; flex-wrap: wrap; gap:12px; }
.card { border:1px solid #ddd; border-radius:12px; padding:12px 14px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
.sensor { width:220px; }
.btn { padding:8px 12px; border:1px solid #333; border-radius:8px; background:#f7f7f7; cursor:pointer; margin-right:6px; }
.btn.active { background:#e8ffe8; border-color:#2b8a3e; }
.muted { color:#777; font-size:12px; }
pre { background:#f5f5f5; padding:10px; border-radius:8px; overflow:auto; }
.tag { display:inline-block; padding:2px 6px; border-radius:6px; background:#eef; margin-right:6px; font-size:12px; }
</style>
<script>
async function setMode(mode){
  await fetch('/mode/'+mode, {method:'POST'});
  refreshAll();
}
async function relay(rid,state){
  await fetch(`/relay/${rid}/${state}`, {method:'POST'});
  refreshAll();
}

async function refreshSensors() {
  let r = await fetch('/sensors');
  let d = await r.json();
  let html = "";
  Object.keys(d.values).forEach(k => {
    let val = d.values[k] ?? '-';
    let unit = (k.toLowerCase().includes("suhu")) ? "Â°C" : "%";  
    html += `<div class="card sensor"><b>${k}</b><br>${val}${unit}<br></div>`;
  });

  document.getElementById('sensors').innerHTML = html;
  document.getElementById('mode').innerText = d.mode.toUpperCase();
  document.getElementById('btn_manual').classList.toggle('active', d.mode=='manual');
  document.getElementById('btn_auto').classList.toggle('active', d.mode=='auto');
  ['1','2','3','4'].forEach(rid=>{
    let state=d.relay[rid];
    document.getElementById('r'+rid).innerText=state;
    document.getElementById('r'+rid+'_on').classList.toggle('active', state=='ON');
    document.getElementById('r'+rid+'_off').classList.toggle('active', state=='OFF');
  });
}
async function refreshDecision(){
  let r = await fetch('/decision'); let d = await r.json();
  let info = document.getElementById('decision');
  if(!d.ready){ info.innerHTML='<i>Menunggu data lengkap...</i>'; return; }
  let html="";
  for(let i=1;i<=3;i++){
    let p='pot_'+i;
    let feats = d.features[p];
    let pred = d.prediction[p];
    let proba = d.proba[p];
    let rules = d.path_rules[p];
    html+=`<h4>Pot ${i}</h4>
      <div><b>Prediksi Siram:</b> ${pred.siram==1?'SIRAM':'TIDAK SIRAM'}<br>
           <b>Prediksi Kipas:</b> ${pred.kipas==1?'NYALA':'MATI'}</div>
      <div>P(Siram=0)=${proba.siram[0].toFixed(2)}, P(Siram=1)=${proba.siram[1].toFixed(2)}</div>
      <div>P(Kipas=0)=${proba.kipas[0].toFixed(2)}, P(Kipas=1)=${proba.kipas[1].toFixed(2)}</div>
      <div style="margin-top:6px">${Object.entries(feats).map(([k,v])=>`<span class="tag">${k}:${v.toFixed(2)}</span>`).join(' ')}</div>
      <div class="muted" style="margin-top:4px">Updated: ${d.updated_at||''}</div>
      <hr>
      <div><b>Jalur Keputusan Siram:</b><br>${(rules.siram||[]).map(r=>"â€¢ "+r).join('<br>')}</div>
      <div><b>Jalur Keputusan Kipas:</b><br>${(rules.kipas||[]).map(r=>"â€¢ "+r).join('<br>')}</div>`;
  }
  info.innerHTML=html;
}
async function refreshRules(){
  let r1 = await fetch('/rules_siram'); let t1 = await r1.text();
  let r2 = await fetch('/rules_kipas'); let t2 = await r2.text();
  document.getElementById('rules_siram').innerText=t1;
  document.getElementById('rules_kipas').innerText=t2;
  document.getElementById('tree_siram').src='/static/tree_siram.png?ts='+Date.now();
  document.getElementById('tree_kipas').src='/static/tree_kipas.png?ts='+Date.now();
}
async function refreshAll(){ refreshSensors(); refreshDecision(); refreshRules(); }
setInterval(refreshAll,1000); window.onload=refreshAll;
</script>
</head>
<body>
<h1>ðŸŒ± Smart Farming Dashboard</h1>

<div class="card" style="margin-bottom:12px;">
Mode: <b id="mode">-</b>
<button class="btn" id="btn_manual" onclick="setMode('manual')">Manual</button>
<button class="btn" id="btn_auto" onclick="setMode('auto')">Otomatis</button>
<span class="muted">Manual: pakai tombol relay. Otomatis: decision tree.</span>
</div>

<h2>Sensor</h2>
<div id="sensors" class="row"></div>

<h2>Kontrol Relay</h2>
<div class="card">
<div>Relay 1 (Pompa Pot 1): <b id="r1">-</b>
<button class="btn" id="r1_on" onclick="relay(1,'ON')">ON</button>
<button class="btn" id="r1_off" onclick="relay(1,'OFF')">OFF</button></div>

<div>Relay 2 (Pompa Pot 2): <b id="r2">-</b>
<button class="btn" id="r2_on" onclick="relay(2,'ON')">ON</button>
<button class="btn" id="r2_off" onclick="relay(2,'OFF')">OFF</button></div>

<div>Relay 3 (Pompa Pot 3): <b id="r3">-</b>
<button class="btn" id="r3_on" onclick="relay(3,'ON')">ON</button>
<button class="btn" id="r3_off" onclick="relay(3,'OFF')">OFF</button></div>

<div>Relay 4 (Kipas Exhaust): <b id="r4">-</b>
<button class="btn" id="r4_on" onclick="relay(4,'ON')">ON</button>
<button class="btn" id="r4_off" onclick="relay(4,'OFF')">OFF</button></div>

<div class="muted" style="margin-top:6px">Catatan: Mode Otomatis mengatur pompa & kipas sesuai prediksi.</div>
</div>

<h2>Decision Insight (Realtime)</h2>
<div id="decision" class="card"></div>

<h2>Decision Tree Penyiraman</h2>
<img id="tree_siram" src="/static/tree_siram.png" width="900" style="border:1px solid #ddd; border-radius:8px;">
<pre id="rules_siram"></pre>

<h2>Decision Tree Kipas</h2>
<img id="tree_kipas" src="/static/tree_kipas.png" width="900" style="border:1px solid #ddd; border-radius:8px;">
<pre id="rules_kipas"></pre>
</body>
</html> 